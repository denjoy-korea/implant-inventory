# Design: 임플란트-재고관리

> 치과 병원용 임플란트 재고관리 시스템 상세 설계

## 1. 시스템 아키텍처

### 1.1 아키텍처 개요

```
┌──────────────────────────────────────────────────────┐
│                   App.tsx (Root)                       │
│          Central State (AppState) + Routing            │
├──────────────┬───────────────────┬───────────────────┤
│  Layout Layer │  Feature Layer    │  Service Layer     │
│  ─────────── │  ────────────────│  ────────────────  │
│  Header      │  DashboardOverview│  excelService     │
│  Sidebar     │  InventoryManager │  sizeNormalizer   │
│              │  OrderManager     │  analysisService  │
│              │  FailManager      │                    │
│              │  ExcelTable       │                    │
│              │  SurgeryStats     │                    │
├──────────────┴───────────────────┴───────────────────┤
│              localStorage (병원별 격리)                 │
└──────────────────────────────────────────────────────┘
```

### 1.2 레이어 구조

| Layer | 역할 | 구성 요소 |
|-------|------|-----------|
| **Presentation** | UI 렌더링, 사용자 인터랙션 | 24개 React 컴포넌트 |
| **State Management** | 중앙 상태 관리, 라우팅 | App.tsx (단일 useState) |
| **Service** | 비즈니스 로직, 데이터 변환 | 3개 서비스 모듈 |
| **Persistence** | 데이터 영속화 | localStorage (병원 prefix 격리) |

## 2. 데이터 모델 설계

### 2.1 핵심 타입 정의 (types.ts)

#### 엑셀 데이터
```typescript
interface ExcelRow { [key: string]: any; }
interface ExcelSheet { name: string; columns: string[]; rows: ExcelRow[]; }
interface ExcelData { sheets: Record<string, ExcelSheet>; activeSheetName: string; }
```

#### 재고 아이템
```typescript
interface InventoryItem {
  id: string;
  manufacturer: string;    // 제조사
  brand: string;            // 브랜드
  size: string;             // 규격
  initialStock: number;     // 초기 재고
  usageCount: number;       // 사용량 (자동 계산)
  currentStock: number;     // 현재 재고 = initialStock + received - usageCount
  recommendedStock: number; // 적정 재고 (자동 추천)
  monthlyAvgUsage?: number; // 월평균 사용량
  dailyMaxUsage?: number;   // 일최대 사용량
}
```

#### 주문
```typescript
type OrderType = 'replenishment' | 'fail_exchange';
type OrderStatus = 'ordered' | 'received';
interface OrderItem { brand: string; size: string; quantity: number; }
interface Order {
  id: string; type: OrderType; manufacturer: string;
  date: string; items: OrderItem[]; manager: string;
  status: OrderStatus; receivedDate?: string;
}
```

#### 사용자 및 병원
```typescript
type UserRole = 'master' | 'dental_staff' | 'staff';
interface Hospital { id: string; name: string; masterAdminId: string; createdAt: string; }
interface User {
  email: string; name: string; role: UserRole;
  hospitalId: string; status?: 'pending' | 'active';
}
```

#### 분석 리포트
```typescript
interface AnalysisReport {
  dataQualityScore: number;           // 0-100점 종합 점수
  diagnostics: DiagnosticItem[];      // 6개 카테고리 진단
  matchedCount: number;               // 매칭된 항목 수
  unmatchedItems: UnmatchedItem[];    // 불일치 항목
  usagePatterns: { ... };             // 사용 패턴 분석
  recommendations: string[];          // 개선 권고사항
}
```

#### 앱 상태
```typescript
interface AppState {
  fixtureData: ExcelData | null;       // 픽스쳐 원본 데이터
  surgeryData: ExcelData | null;       // 수술기록 데이터
  fixtureFileName: string | null;
  surgeryFileName: string | null;
  inventory: InventoryItem[];          // 재고 마스터
  orders: Order[];                     // 주문 목록
  surgeryMaster: Record<string, ExcelRow[]>;  // 누적 수술기록
  activeSurgerySheetName: string;
  selectedFixtureIndices: Record<string, Set<number>>;
  selectedSurgeryIndices: Record<string, Set<number>>;
  isLoading: boolean;
  user: User | null;
  currentView: View;
  dashboardTab: DashboardTab;
  isFixtureLengthExtracted: boolean;
  fixtureBackup: Record<string, { rows: ExcelRow[], columns: string[] }> | null;
  showProfile: boolean;
  adminViewMode: 'admin' | 'user';
}
```

### 2.2 데이터 관계도

```
Hospital (1) ──── (N) User
    │
    └── hospitalId prefix ──┬── app_inventory
                             ├── app_surgery_master
                             ├── app_orders
                             └── app_fixture_data

InventoryItem ◄──── 사용량 매칭 ────► surgeryMaster['수술기록지']
      │                                        │
      │                                        ▼
      └──── Order (replenishment) ◄─── FailManager (fail_exchange)
```

### 2.3 localStorage 키 구조

| 키 패턴 | 용도 | 범위 |
|---------|------|------|
| `app_user` | 현재 로그인 사용자 | 전역 |
| `app_users` | 전체 사용자 목록 | 전역 |
| `app_hospitals` | 전체 병원 목록 | 전역 |
| `hospital_{id}_app_inventory` | 재고 마스터 | 병원별 |
| `hospital_{id}_app_surgery_master` | 수술기록 DB | 병원별 |
| `hospital_{id}_app_orders` | 주문 목록 | 병원별 |
| `hospital_{id}_app_fixture_data` | 픽스쳐 원본 | 병원별 |

## 3. 컴포넌트 설계

### 3.1 컴포넌트 의존성 트리

```
App.tsx
├── Header.tsx                  (비대시보드 네비게이션)
├── Sidebar.tsx                 (대시보드 사이드바)
├── LandingPage.tsx             (랜딩 페이지)
├── AuthForm.tsx                (로그인/회원가입, 603줄)
├── StaffWaitingRoom.tsx        (직원 승인 대기, 171줄)
├── DashboardOverview.tsx       (대시보드 개요, 189줄)
│   └── BrandChart.tsx          (브랜드 차트, 180줄)
├── UploadSection.tsx           (파일 업로드, 65줄)
├── ManufacturerToggle.tsx      (제조사 토글, 83줄)
├── ExcelTable.tsx              (엑셀 테이블, 287줄)
├── InventoryManager.tsx        (재고 관리, 347줄)
├── SurgeryStats.tsx            (수술 통계, 164줄)
├── FailManager.tsx             (FAIL 관리, 502줄)
├── OrderManager.tsx            (주문 관리, 281줄)
├── MemberManager.tsx           (구성원 관리, 312줄)
├── SystemAdminDashboard.tsx    (시스템 관리자, 380줄)
├── UserProfile.tsx             (사용자 프로필, 366줄)
├── PricingPage.tsx             (가격 페이지)
├── ContactPage.tsx             (문의 페이지)
├── ValuePage.tsx               (가치 소개)
├── AnalyzePage.tsx             (분석 페이지)
├── AdminPanel.tsx              (관리자 패널)
└── NewDataModal.tsx            (데이터 추가 모달)
```

### 3.2 주요 컴포넌트 상세 설계

#### App.tsx (Root - 794줄)

**책임**: 중앙 상태 관리, 라우팅, 데이터 영속화, 재고-수술기록 동기화

**핵심 로직**:
- `handleLoginSuccess()`: 로그인 시 병원별 데이터 로드
- `syncInventoryWithUsageAndOrders()`: 수술기록 기반 재고 자동 계산
  - 제조사/브랜드/규격 매칭 (normalize + getSizeMatchKey)
  - 현재재고 = 초기재고 + 입고완료 - 총사용량
  - 적정재고 = max(일최대 × 2, 월평균)
- `handleFileUpload()`: 엑셀 파싱 및 수술기록 자동 분류
  - 구분: 식립, 골이식만, 수술중교환, 청구
  - 자동 추출: 제조사, 브랜드, 규격

**라우팅 구조**:
```
currentView:
  'landing'    → LandingPage
  'login'      → AuthForm (login)
  'signup'     → AuthForm (signup)
  'dashboard'  → dashboardTab 기반 라우팅
  'pricing'    → PricingPage
  'contact'    → ContactPage
  'value'      → ValuePage
  'analyze'    → AnalyzePage

dashboardTab:
  'overview'           → DashboardOverview
  'fixture_upload'     → UploadSection (admin only)
  'fixture_edit'       → ManufacturerToggle + BrandChart + ExcelTable (admin only)
  'inventory_master'   → InventoryManager
  'surgery_database'   → UploadSection + SurgeryStats + ExcelTable
  'fail_management'    → FailManager
  'order_management'   → OrderManager
  'member_management'  → MemberManager
```

#### InventoryManager.tsx (347줄)

**책임**: 재고 마스터 CRUD, 사용량 분석, 빠른 발주

**Props Interface**:
```typescript
{
  inventory: InventoryItem[];
  onUpdateStock: (id: string, value: number) => void;
  onDeleteInventoryItem: (id: string) => void;
  onAddInventoryItem: (item: InventoryItem) => void;
  onUpdateInventoryItem: (item: InventoryItem) => void;
  surgeryData: ExcelData | null;
  onQuickOrder: (item: InventoryItem) => void;
}
```

**내부 상태**: monthFactor, activeManufacturers, editingItemId, isAddingItem

**재고 계산 로직**:
```
currentStock = initialStock + totalReceived - totalUsage
recommendedStock = max(dailyMaxUsage × 2, ceil(monthlyAvgUsage))
lowStock = currentStock ≤ recommendedStock × 0.3
```

#### FailManager.tsx (502줄)

**책임**: 수술 중 FAIL 건 추적, 교환 주문 생성, 상태 관리

**FAIL 처리 플로우**:
```
수술기록 업로드 → FAIL 자동 분류 ('수술중교환')
    → FAIL 목록 표시 (제조사별 그룹핑)
    → 교환 주문 생성 (type: 'fail_exchange')
    → 입고 확인 시 수술기록 상태 변경 ('교환완료')
```

#### AuthForm.tsx (603줄)

**책임**: 회원가입/로그인, 역할 선택, 병원 생성

**2단계 회원가입 플로우**:
```
Step 1: 역할 선택
  ├── 치과의사 (Master) → Step 2: 병원 정보 + 개인 정보
  └── 스탭 (Staff) → Step 2: 개인 정보만

비밀번호 규칙: 8자 이상, 대문자, 소문자, 숫자, 특수문자 포함
```

## 4. 서비스 레이어 설계

### 4.1 excelService.ts (80줄)

| 함수 | 입력 | 출력 | 역할 |
|------|------|------|------|
| `parseExcelFile(file)` | File | ExcelData | XLSX 파싱, 시트별 데이터 추출 |
| `extractLengthFromSize(size)` | string | number \| null | 규격에서 길이 추출 |
| `downloadExcelFile(data, indices, name)` | ExcelData, Set, string | void | 필터링 후 엑셀 다운로드 |

### 4.2 sizeNormalizer.ts (221줄)

**지원 규격 포맷 (6종)**:

| 포맷 | 제조사 | 예시 | 파싱 결과 |
|------|--------|------|-----------|
| A | Dentium | `3507` | D3.5 L7 |
| A | Dentium | `483410` | D4.8/3.4 L10 |
| B/B2 | OSSTEM, 디오, 메가젠 | `Φ4.0 × 10` | D4.0 L10 |
| C | 덴티스, 탑플란 | `Ø3.6 × 10mm` | D3.6 L10 |
| D | Magicore | `Cuff3.0 Φ4.5×11.5` | D4.5 L11.5 Cuff3.0 |
| E | 메가젠 BLUEDIAMOND | `Ø4.0 / L10` | D4.0 L10 |
| F | IBS 수술기록 | `D:4.0 L:10` | D4.0 L10 |

**핵심 함수**:
```typescript
parseSize(raw: string, manufacturer: string): ParsedSize
getSizeMatchKey(raw: string, manufacturer: string): string  // "D{d}_L{l}" 형식
```

### 4.3 analysisService.ts (540줄)

**6개 카테고리 진단 시스템 (100점 만점)**:

| 카테고리 | 배점 | 검증 내용 |
|----------|------|-----------|
| FAIL 관리 | 15점 | FAIL 레코드 정상 분리 |
| 보험청구 분류 | 15점 | 2단계 분류 체계 |
| 수술→픽스쳐 매칭 | 25점 | 수술기록의 픽스쳐 매칭률 |
| 픽스쳐→수술 활용 | 20점 | 픽스쳐 실사용률 (사장재고 탐지) |
| 명칭 일관성 | 15점 | 제조사/브랜드명 변이 감지 |
| 규격 포맷 일관성 | 10점 | 그룹 내 포맷 동질성 |

## 5. 데이터 흐름 설계

### 5.1 재고 자동 동기화 (핵심 플로우)

```
수술기록 업로드
    ↓ handleFileUpload('surgery')
    ↓ parseExcelFile() → 파싱
    ↓ 수술기록 자동 분류 (구분, 제조사, 브랜드, 규격 추출)
    ↓ surgeryMaster 업데이트
    ↓
syncInventoryWithUsageAndOrders() ← useEffect 트리거
    ↓
inventory.map(item => {
    ↓ normalize(manufacturer) + getSizeMatchKey(size)
    ↓ surgeryMaster 매칭 → totalUsage 계산
    ↓ dailyUsage → dailyMax, monthlyAvg
    ↓ orders(received) 매칭 → totalReceived 계산
    ↓
    currentStock = initialStock + totalReceived - totalUsage
    recommendedStock = max(dailyMax × 2, ceil(monthlyAvg))
})
    ↓
localStorage 자동 저장 (useEffect)
```

### 5.2 FAIL 교환 플로우

```
수술기록에서 '수술중교환_' 패턴 감지
    ↓ 구분: '수술중교환' 자동 분류
    ↓
FailManager 표시 (제조사별 FAIL 건수)
    ↓ 교환 주문 생성 (type: 'fail_exchange')
    ↓
handleAddOrder()
    ↓ 수술기록에서 해당 FAIL 레코드를 '교환완료'로 변경
    ↓ orders에 주문 추가
    ↓
OrderManager에서 입고 처리
    ↓ status: 'received'
    ↓ syncInventoryWithUsageAndOrders() 재계산
```

### 5.3 픽스쳐 데이터 → 재고 마스터 반영 플로우

```
픽스쳐 엑셀 업로드
    ↓ parseExcelFile()
    ↓ fixtureData 저장
    ↓
ManufacturerToggle → 제조사별 사용/미사용 토글
BrandChart → 브랜드별 사용/미사용 토글
ExcelTable → 개별 행 편집
    ↓
"재고 마스터 반영" 버튼
    ↓ 사용안함 !== true인 행만 필터
    ↓ 기존 inventory와 중복 체크 (normalize + getSizeMatchKey)
    ↓ 신규 아이템만 inventory에 추가 (initialStock: 10)
```

## 6. 접근 제어 설계

### 6.1 역할별 접근 권한

| 기능 | System Admin | Master | Staff (active) | Staff (pending) |
|------|:---:|:---:|:---:|:---:|
| SystemAdminDashboard | O | - | - | - |
| 픽스쳐 업로드/편집 | O | - | - | - |
| 재고 마스터 | - | O | O | - |
| 수술기록 DB | - | O | O | - |
| FAIL 관리 | - | O | O | - |
| 주문 관리 | - | O | O | - |
| 구성원 관리 | - | O | - | - |
| StaffWaitingRoom | - | - | - | O |

### 6.2 Admin 판별 로직
```typescript
const isAdmin = user?.email === 'admin'
  || user?.email === 'admin@admin.com'
  || user?.email === 'admin@test.com';
```

### 6.3 병원 데이터 격리
```typescript
const prefix = `hospital_${user.hospitalId}_`;
// 모든 병원별 데이터 접근 시 prefix 사용
localStorage.getItem(`${prefix}app_inventory`);
```

## 7. UI/UX 설계

### 7.1 뷰 구조

```
[비인증 상태]
  Landing → Login/Signup → Dashboard

[인증 상태 - 일반 사용자]
  Dashboard (Sidebar + Content)
    ├── Overview (KPI 카드 4개 + 브랜드 차트)
    ├── 로우데이터 업로드 (admin only)
    ├── 데이터 설정/가공 (admin only)
    ├── 재고 마스터 (테이블 + 제조사 필터 + TOP 12 차트)
    ├── 수술기록 DB (업로드 + 통계 + 테이블)
    ├── FAIL 관리 (FAIL 목록 + 교환 주문)
    ├── 주문 관리 (주문 목록 + 상태 변경)
    └── 구성원 관리 (master only)

[인증 상태 - System Admin]
  SystemAdminDashboard
    ├── 병원 목록
    ├── 사용자 목록
    └── 시스템 모니터링
```

### 7.2 디자인 시스템

| 요소 | 사양 |
|------|------|
| 색상 체계 | Indigo (주), Rose (경고), Emerald (성공), Slate (중립) |
| 폰트 | Tailwind CSS 기본 |
| 레이아웃 | Sidebar(고정) + Content(스크롤), max-w-7xl |
| 카드 | rounded-2xl, shadow-sm, border-slate-200 |
| 버튼 | rounded-lg, 크기별 px/py, hover 효과 |
| 상태 표시 | 뱃지 (rounded-full), 애니메이션 (ping) |

### 7.3 대시보드 헤더

```
[날짜] | [현재 탭명]  [액션 버튼들]        [구독 잔여일] | [프로필] [역할] | [홈] [로그아웃]
```

## 8. 구현 순서 (Implementation Order)

### Phase 1: 핵심 인프라
1. `types.ts` - 타입 정의
2. `services/excelService.ts` - 엑셀 파싱
3. `services/sizeNormalizer.ts` - 규격 정규화

### Phase 2: 인증 및 레이아웃
4. `components/AuthForm.tsx` - 회원가입/로그인
5. `components/Header.tsx` - 상단 네비게이션
6. `components/Sidebar.tsx` - 사이드 내비게이션
7. `components/StaffWaitingRoom.tsx` - 승인 대기

### Phase 3: 데이터 업로드/가공
8. `components/UploadSection.tsx` - 파일 업로드
9. `components/ExcelTable.tsx` - 데이터 테이블
10. `components/ManufacturerToggle.tsx` - 제조사 토글
11. `components/BrandChart.tsx` - 브랜드 차트

### Phase 4: 재고 및 주문
12. `components/InventoryManager.tsx` - 재고 관리
13. `components/OrderManager.tsx` - 주문 관리
14. `components/FailManager.tsx` - FAIL 관리

### Phase 5: 대시보드 및 분석
15. `components/DashboardOverview.tsx` - 대시보드
16. `components/SurgeryStats.tsx` - 수술 통계
17. `services/analysisService.ts` - 분석 서비스
18. `components/AnalyzePage.tsx` - 분석 페이지

### Phase 6: 사용자/관리
19. `components/MemberManager.tsx` - 구성원 관리
20. `components/UserProfile.tsx` - 프로필
21. `components/SystemAdminDashboard.tsx` - 시스템 관리

### Phase 7: 마케팅 페이지
22. `components/LandingPage.tsx` - 랜딩
23. `components/PricingPage.tsx` - 가격
24. `components/ValuePage.tsx` - 가치
25. `components/ContactPage.tsx` - 문의

### Phase 8: 통합
26. `App.tsx` - 전체 통합, 라우팅, 상태 관리

## 9. 주요 알고리즘

### 9.1 수술기록 자동 파싱

```
입력: 수술기록 텍스트 (예: "OSSTEM-TS III SA/Φ4.0×10/H4.5")

1. 구분 판별:
   - '[GBR Only]' 포함 → '골이식만'
   - '수술중교환_' 포함 → '수술중교환'
   - '보험임플란트' 포함 → '청구'
   - 기본값 → '식립'

2. 파싱 ('-' 기반 분리):
   - 첫 번째 부분 → 제조사 (FAIL/보험 접두어 제거)
   - 나머지 → '/' 기준 분리 → 브랜드 + 규격

3. 갯수 판별:
   - 치아번호에 ',' 포함 → 쉼표 개수 + 1
   - 치아번호 존재 → 1
   - 기록만 존재 → 1
```

### 9.2 규격 매칭 키 생성

```
입력: raw="Φ4.0 × 10", manufacturer="OSSTEM"

1. parseSize(raw, manufacturer)
2. 포맷별 정규식 매칭 (B/B2 포맷 선택)
3. diameter=4.0, length=10
4. matchKey = "D4.0_L10"

비교: inventory.size matchKey === surgeryRecord.size matchKey
```

## 10. 품질 기준

### 10.1 코드 품질
- TypeScript strict 모드
- 모든 Props에 명시적 타입 정의
- useMemo/useCallback 최적화 적용
- 인라인 스타일 대신 Tailwind CSS 클래스 사용

### 10.2 기능 검증 기준
- 수술기록 ↔ 재고 매칭 정확도 ≥ 95%
- 6종 규격 포맷 모두 정상 파싱
- 병원 간 데이터 격리 100%
- FAIL 교환 플로우 완전성
- 재고 자동 계산 정확성

### 10.3 성능 기준
- 페이지 로드 ≤ 3초
- 엑셀 파싱 (1000행) ≤ 2초
- 재고 동기화 ≤ 500ms
- 렌더링 지연 없음 (useMemo 적용)

---

**Created**: 2026-02-15
**Level**: Dynamic
**Phase**: Design
**Plan Reference**: docs/01-plan/features/임플란트-재고관리.plan.md
