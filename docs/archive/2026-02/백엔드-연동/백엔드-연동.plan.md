# Plan: 백엔드-연동

> localStorage 기반 시스템을 Supabase 백엔드로 마이그레이션

## 1. 프로젝트 개요

### 1.1 목적
현재 localStorage 기반으로 동작하는 임플란트 재고관리 시스템에 Supabase 백엔드를 연동하여 데이터 영속성, 멀티 디바이스 지원, 보안 강화를 달성한다.

### 1.2 배경 (이전 PDCA 분석 결과)
| 현재 한계 | 해결 방안 |
|-----------|----------|
| localStorage 기반 → 데이터 손실 위험 | Supabase PostgreSQL DB |
| 클라이언트 사이드 인증 → 보안 취약 | Supabase Auth (JWT) |
| 단일 브라우저 → 멀티 디바이스 미지원 | Supabase Realtime |
| 비밀번호 미암호화 | Supabase Auth 자동 해싱 |
| 파일 저장 불가 | Supabase Storage |

### 1.3 대상 범위
기존 32개 기능(F-01 ~ F-32) 중 백엔드 연동이 필요한 영역:

| 영역 | 현재 (As-Is) | 목표 (To-Be) |
|------|-------------|-------------|
| 인증 | localStorage 직접 관리 | Supabase Auth |
| 사용자 관리 | `app_users` localStorage | `users` 테이블 |
| 병원 관리 | `app_hospitals` localStorage | `hospitals` 테이블 |
| 재고 데이터 | `hospital_{id}_app_inventory` | `inventory` 테이블 |
| 수술기록 | `hospital_{id}_app_surgery_master` | `surgery_records` 테이블 |
| 주문 관리 | `hospital_{id}_app_orders` | `orders` + `order_items` 테이블 |
| 픽스쳐 데이터 | `hospital_{id}_app_fixture_data` | Supabase Storage + `fixtures` 테이블 |

## 2. 핵심 기능 (Feature List)

### 2.1 Supabase Auth 연동
- [B-01] Supabase Auth 이메일/비밀번호 회원가입
- [B-02] Supabase Auth 로그인/로그아웃
- [B-03] JWT 기반 세션 관리 (자동 토큰 갱신)
- [B-04] 비밀번호 재설정 (이메일)
- [B-05] 사용자 프로필 관리 (user_metadata)

### 2.2 데이터베이스 마이그레이션
- [B-06] hospitals 테이블 생성 및 RLS 정책
- [B-07] users 프로필 테이블 생성 (auth.users 연동)
- [B-08] inventory 테이블 생성 및 RLS
- [B-09] surgery_records 테이블 생성 및 RLS
- [B-10] orders / order_items 테이블 생성 및 RLS
- [B-11] 병원별 데이터 격리 (RLS 기반)

### 2.3 API 서비스 레이어
- [B-12] Supabase Client 초기화 (supabaseClient.ts)
- [B-13] authService.ts (회원가입, 로그인, 로그아웃, 세션)
- [B-14] hospitalService.ts (병원 CRUD, 멤버 관리)
- [B-15] inventoryService.ts (재고 CRUD, 사용량 조회)
- [B-16] surgeryService.ts (수술기록 CRUD, 파싱 후 저장)
- [B-17] orderService.ts (주문 CRUD, 상태 변경)

### 2.4 데이터 동기화
- [B-18] localStorage → Supabase 초기 마이그레이션 유틸
- [B-19] Supabase Realtime 구독 (재고 변경 알림)
- [B-20] 오프라인 폴백 (네트워크 끊김 시 localStorage 임시 저장)

### 2.5 파일 스토리지
- [B-21] Supabase Storage 버킷 생성 (엑셀 파일)
- [B-22] 엑셀 파일 업로드/다운로드 Storage 연동

### 2.6 보안 강화
- [B-23] Row Level Security (RLS) 전체 테이블 적용
- [B-24] 역할 기반 접근 제어 (master/staff DB 레벨)
- [B-25] API 키 환경변수 관리 (.env)

## 3. 기술 스택

| 구분 | 기술 |
|------|------|
| Backend | Supabase (PostgreSQL, Auth, Storage, Realtime) |
| Frontend | React 19 + TypeScript 5.8 (기존) |
| Supabase Client | @supabase/supabase-js v2 |
| 상태 관리 | React useState → React Context + useReducer (부분 리팩토링) |
| 환경 변수 | Vite env (.env.local) |
| 기존 유지 | Vite 6, Tailwind CSS, xlsx |

## 4. 데이터베이스 스키마

### 4.1 테이블 설계

```sql
-- 병원
CREATE TABLE hospitals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  master_admin_id UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 사용자 프로필 (auth.users 확장)
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT NOT NULL,
  name TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('master', 'dental_staff', 'staff')),
  hospital_id UUID REFERENCES hospitals(id),
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'active')),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 재고
CREATE TABLE inventory (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hospital_id UUID REFERENCES hospitals(id) NOT NULL,
  manufacturer TEXT NOT NULL,
  brand TEXT NOT NULL,
  size TEXT NOT NULL,
  initial_stock INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- 수술기록
CREATE TABLE surgery_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hospital_id UUID REFERENCES hospitals(id) NOT NULL,
  date DATE,
  patient_info TEXT,
  tooth_number TEXT,
  quantity INTEGER DEFAULT 1,
  surgery_record TEXT,
  classification TEXT,
  manufacturer TEXT,
  brand TEXT,
  size TEXT,
  bone_quality TEXT,
  initial_fixation TEXT,
  healing TEXT,
  next_visit TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 주문
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hospital_id UUID REFERENCES hospitals(id) NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('replenishment', 'fail_exchange')),
  manufacturer TEXT NOT NULL,
  date DATE NOT NULL,
  manager TEXT NOT NULL,
  status TEXT DEFAULT 'ordered' CHECK (status IN ('ordered', 'received')),
  received_date DATE,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 주문 항목
CREATE TABLE order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  brand TEXT NOT NULL,
  size TEXT NOT NULL,
  quantity INTEGER NOT NULL
);
```

### 4.2 RLS 정책 (병원별 격리)

```sql
-- inventory: 같은 병원 멤버만 접근
ALTER TABLE inventory ENABLE ROW LEVEL SECURITY;
CREATE POLICY "hospital_isolation" ON inventory
  USING (hospital_id IN (
    SELECT hospital_id FROM profiles WHERE id = auth.uid()
  ));

-- 동일 패턴을 surgery_records, orders, order_items에 적용
```

### 4.3 localStorage → Supabase 매핑

| localStorage 키 | Supabase 테이블 | 비고 |
|-----------------|-----------------|------|
| `app_user` | `auth.users` + `profiles` | 세션 자동 관리 |
| `app_users` | `profiles` | 전체 사용자 목록 |
| `app_hospitals` | `hospitals` | UUID 기반 |
| `hospital_{id}_app_inventory` | `inventory` (hospital_id FK) | RLS 격리 |
| `hospital_{id}_app_surgery_master` | `surgery_records` (hospital_id FK) | RLS 격리 |
| `hospital_{id}_app_orders` | `orders` + `order_items` (hospital_id FK) | 정규화 |
| `hospital_{id}_app_fixture_data` | Supabase Storage + metadata | 파일 저장 |

## 5. 마이그레이션 전략

### 5.1 점진적 마이그레이션 (Strangler Fig 패턴)

```
Phase 1: Supabase 세팅 + Auth 연동
  → 로그인/회원가입만 Supabase Auth로 전환
  → 나머지는 localStorage 유지

Phase 2: 핵심 데이터 마이그레이션
  → hospitals, profiles 테이블 연동
  → inventory, surgery_records 테이블 연동
  → orders 테이블 연동

Phase 3: 완전 전환
  → localStorage 의존성 제거
  → Realtime 구독 적용
  → Storage 연동 (엑셀 파일)

Phase 4: 정리
  → localStorage 폴백 코드 제거
  → 마이그레이션 유틸 제거
  → 최종 테스트
```

### 5.2 호환성 유지

마이그레이션 기간 중 기존 localStorage 데이터를 Supabase로 import하는 유틸 제공:
- `migrationService.ts`: localStorage 데이터 읽기 → Supabase insert
- 사용자가 "데이터 마이그레이션" 버튼 클릭 시 실행
- 성공 후 localStorage 정리

## 6. 구현 순서

### Phase 1: 인프라 세팅 (B-12, B-25)
1. Supabase 프로젝트 생성
2. `@supabase/supabase-js` 설치
3. `supabaseClient.ts` 생성
4. `.env.local` 환경변수 설정

### Phase 2: Auth 연동 (B-01~B-05, B-13)
5. `authService.ts` 생성
6. `AuthForm.tsx` 수정 (Supabase Auth 연동)
7. `App.tsx` 세션 관리 수정

### Phase 3: DB 스키마 (B-06~B-11, B-23~B-24)
8. Supabase SQL Editor로 테이블 생성
9. RLS 정책 적용
10. `hospitalService.ts` 생성

### Phase 4: 핵심 서비스 (B-14~B-17)
11. `inventoryService.ts` 생성
12. `surgeryService.ts` 생성
13. `orderService.ts` 생성

### Phase 5: 컴포넌트 연동 (기존 컴포넌트 수정)
14. `InventoryManager.tsx` Supabase 연동
15. `OrderManager.tsx` Supabase 연동
16. `FailManager.tsx` Supabase 연동
17. `MemberManager.tsx` Supabase 연동
18. `DashboardOverview.tsx` Supabase 연동

### Phase 6: 동기화 및 스토리지 (B-18~B-22)
19. `migrationService.ts` 생성
20. Supabase Realtime 구독
21. Supabase Storage 연동

### Phase 7: 정리
22. localStorage 의존성 제거
23. 최종 통합 테스트

## 7. 파일 변경 목록

### 신규 파일
| 파일 | 역할 |
|------|------|
| `services/supabaseClient.ts` | Supabase 클라이언트 초기화 |
| `services/authService.ts` | 인증 서비스 |
| `services/hospitalService.ts` | 병원 관리 서비스 |
| `services/inventoryService.ts` | 재고 관리 서비스 |
| `services/surgeryService.ts` | 수술기록 서비스 |
| `services/orderService.ts` | 주문 관리 서비스 |
| `services/migrationService.ts` | localStorage→Supabase 마이그레이션 |
| `.env.local` | Supabase 환경변수 |

### 수정 파일
| 파일 | 변경 내용 |
|------|-----------|
| `App.tsx` | Supabase Auth 세션 관리, localStorage 제거 |
| `components/AuthForm.tsx` | Supabase Auth 연동 |
| `components/InventoryManager.tsx` | DB CRUD 연동 |
| `components/OrderManager.tsx` | DB CRUD 연동 |
| `components/FailManager.tsx` | DB CRUD 연동 |
| `components/MemberManager.tsx` | DB 연동 (병원 멤버 관리) |
| `components/DashboardOverview.tsx` | DB 기반 통계 |
| `components/StaffWaitingRoom.tsx` | DB 기반 승인 플로우 |
| `components/UserProfile.tsx` | Supabase Auth 프로필 |
| `types.ts` | DB 스키마 정합 타입 추가 |
| `package.json` | @supabase/supabase-js 추가 |
| `vite.config.ts` | env 설정 (필요 시) |

## 8. 리스크 및 대응

| 리스크 | 영향 | 대응 |
|--------|------|------|
| Supabase 무료 한도 초과 | 서비스 중단 | 사용량 모니터링, Pro 플랜 대비 |
| 마이그레이션 중 데이터 손실 | 기존 데이터 유실 | localStorage 백업 유지, 단계적 전환 |
| RLS 설정 오류 | 데이터 유출 | 테스트 환경에서 충분한 검증 |
| 네트워크 의존성 증가 | 오프라인 사용 불가 | 오프라인 폴백 구현 (B-20) |
| 기존 수술기록 파싱 로직 | DB 저장 시 구조 변경 | 파싱 후 정규화된 형태로 저장 |

## 9. 성공 기준

- [ ] Supabase Auth로 회원가입/로그인 정상 동작
- [ ] 병원별 RLS 데이터 격리 100% 동작
- [ ] 재고/수술기록/주문 CRUD 전수 Supabase 연동
- [ ] 기존 localStorage 데이터 Supabase 마이그레이션 성공
- [ ] 멀티 디바이스에서 동일 데이터 접근 가능
- [ ] 페이지 로드 시간 3초 이내 유지

## 10. 의존성

| 패키지 | 버전 | 용도 |
|--------|------|------|
| @supabase/supabase-js | ^2.x | Supabase JavaScript Client |
| (기존) react | ^19.2.3 | UI 프레임워크 |
| (기존) xlsx | ^0.18.5 | 엑셀 파싱 |

---

**Created**: 2026-02-15
**Level**: Dynamic
**Phase**: Plan
**Previous PDCA**: 임플란트-재고관리 (Match Rate: 91%, Archived)
